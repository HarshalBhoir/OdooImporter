
CREATE OR REPLACE FUNCTION pic_id_update_func()

--ATT 20170529-0120 - UPDATE PIC COLUMN IN PARENT TABLE mcorretiva_mco_form WITH ID IN FILE, WHERE LAST PARENT ID IS EQUAL.

RETURNS trigger AS $pic_id_update_trigger$

--GET LAST ID FROM PARENT TABLE mcorretiva_mco_form
DECLARE parentId int := (SELECT mcorretiva_mco_form.id FROM mcorretiva_mco_form ORDER BY mcorretiva_mco_form.id DESC LIMIT 1);

BEGIN

--PIC01 - EPI
IF (new.mco_form_file_description = 'PIC01') THEN
UPDATE mcorretiva_mco_form SET mco_form_file_pic01_id=new.id WHERE mcorretiva_mco_form.id = parentId;
RETURN NEW;

--PIC02 - EPC Pista Principal
ELSIF (new.mco_form_file_description = 'PIC02') THEN
UPDATE mcorretiva_mco_form SET mco_form_file_pic02_id=new.id WHERE mcorretiva_mco_form.id = parentId;
RETURN NEW;

--PIC03 - Selo de Manutenção Pista Principal antes do atendimento
ELSIF (new.mco_form_file_description = 'PIC03') THEN
UPDATE mcorretiva_mco_form SET mco_form_file_pic03_id=new.id WHERE mcorretiva_mco_form.id = parentId;
RETURN NEW;

--PIC04 - Armário Fechado com Moldura Pista Principal antes do atendimento
ELSIF (new.mco_form_file_description = 'PIC04') THEN
UPDATE mcorretiva_mco_form SET mco_form_file_pic04_id=new.id WHERE mcorretiva_mco_form.id = parentId;
RETURN NEW;

--PIC05 - Armário Aberto Pista Principal antes do atendimento
ELSIF (new.mco_form_file_description = 'PIC05') THEN
UPDATE mcorretiva_mco_form SET mco_form_file_pic05_id=new.id WHERE mcorretiva_mco_form.id = parentId;
RETURN NEW;

--PIC06 - Armário Aberto Pista Principal após atendimento
ELSIF (new.mco_form_file_description = 'PIC06') THEN
UPDATE mcorretiva_mco_form SET mco_form_file_pic06_id=new.id WHERE mcorretiva_mco_form.id = parentId;
RETURN NEW;

--PIC07 - Armário Fechado com Moldura Pista Principal após atendimento
ELSIF (new.mco_form_file_description = 'PIC07') THEN
UPDATE mcorretiva_mco_form SET mco_form_file_pic07_id=new.id WHERE mcorretiva_mco_form.id = parentId;
RETURN NEW;

--PIC08 - Selo de Manutenção Pista Principal após atendimento
ELSIF (new.mco_form_file_description = 'PIC08') THEN
UPDATE mcorretiva_mco_form SET mco_form_file_pic08_id=new.id WHERE mcorretiva_mco_form.id = parentId;
RETURN NEW;

--PIC09 - EPC Pista Secundária
ELSIF (new.mco_form_file_description = 'PIC09') THEN
UPDATE mcorretiva_mco_form SET mco_form_file_pic09_id=new.id WHERE mcorretiva_mco_form.id = parentId;
RETURN NEW;

--PIC10 - Selo de Manutenção Pista Secundária antes do atendimento
ELSIF (new.mco_form_file_description = 'PIC10') THEN
UPDATE mcorretiva_mco_form SET mco_form_file_pic10_id=new.id WHERE mcorretiva_mco_form.id = parentId;
RETURN NEW;

--PIC11 - Armário Fechado com Moldura Pista Secundária antes do atendimento
ELSIF (new.mco_form_file_description = 'PIC11') THEN
UPDATE mcorretiva_mco_form SET mco_form_file_pic11_id=new.id WHERE mcorretiva_mco_form.id = parentId;
RETURN NEW;

--PIC12 - Armário Aberto Pista Secundária antes do atendimento
ELSIF (new.mco_form_file_description = 'PIC12') THEN
UPDATE mcorretiva_mco_form SET mco_form_file_pic12_id=new.id WHERE mcorretiva_mco_form.id = parentId;
RETURN NEW;

--PIC13 - Armário Aberto Pista Secundária após atendimento
ELSIF (new.mco_form_file_description = 'PIC13') THEN
UPDATE mcorretiva_mco_form SET mco_form_file_pic13_id=new.id WHERE mcorretiva_mco_form.id = parentId;
RETURN NEW;

--PIC14 - Armário Fechado com Moldura Pista Secundária após atendimento
ELSIF (new.mco_form_file_description = 'PIC14') THEN
UPDATE mcorretiva_mco_form SET mco_form_file_pic14_id=new.id WHERE mcorretiva_mco_form.id = parentId;
RETURN NEW;

--PIC15 - Selo de Manutenção Pista Secundária após atendimento
ELSIF (new.mco_form_file_description = 'PIC15') THEN
UPDATE mcorretiva_mco_form SET mco_form_file_pic15_id=new.id WHERE mcorretiva_mco_form.id = parentId;
RETURN NEW;

--PIC16 - Selo Manutenção Rack do Servidor antes do atendimento
ELSIF (new.mco_form_file_description = 'PIC16') THEN
UPDATE mcorretiva_mco_form SET mco_form_file_pic16_id=new.id WHERE mcorretiva_mco_form.id = parentId;
RETURN NEW;

--PIC17 - Rack do Servidor fechado antes do atendimento
ELSIF (new.mco_form_file_description = 'PIC17') THEN
UPDATE mcorretiva_mco_form SET mco_form_file_pic17_id=new.id WHERE mcorretiva_mco_form.id = parentId;
RETURN NEW;

--PIC18 - Rack do Servidor aberto antes do atendimento
ELSIF (new.mco_form_file_description = 'PIC18') THEN
UPDATE mcorretiva_mco_form SET mco_form_file_pic18_id=new.id WHERE mcorretiva_mco_form.id = parentId;
RETURN NEW;

--PIC19 - Rack do Servidor aberto após atendimento
ELSIF (new.mco_form_file_description = 'PIC19') THEN
UPDATE mcorretiva_mco_form SET mco_form_file_pic19_id=new.id WHERE mcorretiva_mco_form.id = parentId;
RETURN NEW;

--PIC20 - Rack do Servidor fechado após atendimento
ELSIF (new.mco_form_file_description = 'PIC20') THEN
UPDATE mcorretiva_mco_form SET mco_form_file_pic20_id=new.id WHERE mcorretiva_mco_form.id = parentId;
RETURN NEW;

--PIC21 - Selo Manutenção Rack do Servidor após atendimento
ELSIF (new.mco_form_file_description = 'PIC21') THEN
UPDATE mcorretiva_mco_form SET mco_form_file_pic21_id=new.id WHERE mcorretiva_mco_form.id = parentId;
RETURN NEW;

--PIC22 - Luminárias Acessas Pista Principal antes do atendimento
ELSIF (new.mco_form_file_description = 'PIC22') THEN
UPDATE mcorretiva_mco_form SET mco_form_file_pic22_id=new.id WHERE mcorretiva_mco_form.id = parentId;
RETURN NEW;

--PIC23 - Luminárias Acessas Pista Principal após atendimento
ELSIF (new.mco_form_file_description = 'PIC23') THEN
UPDATE mcorretiva_mco_form SET mco_form_file_pic23_id=new.id WHERE mcorretiva_mco_form.id = parentId;
RETURN NEW;

--PIC24 - Luminárias Acessas Pista Secundária antes do atendimento
ELSIF (new.mco_form_file_description = 'PIC24') THEN
UPDATE mcorretiva_mco_form SET mco_form_file_pic24_id=new.id WHERE mcorretiva_mco_form.id = parentId;
RETURN NEW;

--PIC25 - Luminárias Acessas Pista Secundária após atendimento
ELSIF (new.mco_form_file_description = 'PIC25') THEN
UPDATE mcorretiva_mco_form SET mco_form_file_pic25_id=new.id WHERE mcorretiva_mco_form.id = parentId;
RETURN NEW;

--PIC26 - Teste de Abastecimento Pista Principal
ELSIF (new.mco_form_file_description = 'PIC26') THEN
UPDATE mcorretiva_mco_form SET mco_form_file_pic26_id=new.id WHERE mcorretiva_mco_form.id = parentId;
RETURN NEW;

--PIC27 - Teste de Abastecimento Pista Secundária
ELSIF (new.mco_form_file_description = 'PIC27') THEN
UPDATE mcorretiva_mco_form SET mco_form_file_pic27_id=new.id WHERE mcorretiva_mco_form.id = parentId;
RETURN NEW;

--PIC28 - Assinatura do Responsável pelo posto
ELSIF (new.mco_form_file_description = 'PIC28') THEN
UPDATE mcorretiva_mco_form SET mco_form_file_pic28_id=new.id WHERE mcorretiva_mco_form.id = parentId;
RETURN NEW;

END IF;
RETURN NULL;
END;

$pic_id_update_trigger$ LANGUAGE plpgsql;



  ---------------------------------------  

  CREATE TRIGGER pic_id_update_trigger
  AFTER INSERT ON mcorretiva_mco_form_files
  FOR EACH ROW
  EXECUTE PROCEDURE pic_id_update_func();



  ---------------------------------------
SELECTS:
  ---------------------------------------


SELECT 
id,
mco_form_file_pic01,
mco_form_file_pic02,
mco_form_file_pic03,
mco_form_file_pic04,
mco_form_file_pic05,
mco_form_file_pic06,
mco_form_file_pic07,
mco_form_file_pic08,
mco_form_file_pic09,
mco_form_file_pic10,
mco_form_file_pic11,
mco_form_file_pic12,
mco_form_file_pic13,
mco_form_file_pic14,
mco_form_file_pic15,
mco_form_file_pic16,
mco_form_file_pic17,
mco_form_file_pic18,
mco_form_file_pic19,
mco_form_file_pic20,
mco_form_file_pic21,
mco_form_file_pic22,
mco_form_file_pic23,
mco_form_file_pic24,
mco_form_file_pic25,
mco_form_file_pic26,
mco_form_file_pic27,
mco_form_file_pic28
FROM mcorretiva_mco_form;


  ---------------------------------------


SELECT COUNT(1) FROM mcorretiva_mco_form;
SELECT COUNT(1) FROM mcorretiva_mco_form_files;
SELECT COUNT(1) FROM mcorretiva_mco_form_equipments;

  ---------------------------------------

  ---------------------------------------
TRUNCATE:
  ---------------------------------------

TRUNCATE mcorretiva_mco_form 
RESTART IDENTITY CASCADE;





  ---------------------------------------
ODOO:
  ---------------------------------------
-----------------
select * FROM public.ir_model
WHERE name like '%mcorretiva%'

select * FROM public.ir_model_data
WHERE name like '%mcorretiva%'

select * FROM public.ir_module_module
WHERE name like '%mcorretiva%'

------------------------------------------

delete FROM public.ir_model
WHERE name like '%mcorretiva%';

delete FROM public.ir_model_fields
WHERE model like '%mcorretiva%';

delete FROM public.ir_model_data
WHERE name like '%mcorretiva%';

delete FROM public.ir_module_module
WHERE name like '%mcorretiva%';

------------------------------------------





